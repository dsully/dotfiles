#!/usr/bin/python

# Automatically set external drives to not be spotlight indexed.
#
# Run automatically in conjunction with a LaunchAgent:
#
# launchctl load -w ~/Dropbox/Library/LaunchAgents/org.sully.index.no_index.plist
#
# See: http://hints.macworld.com/article.php?story=2010050112180751

import os
import re
import subprocess
import time

def main():

  df = subprocess.Popen(['/bin/df'], stdout=subprocess.PIPE).communicate()[0]

  for line in df.split('\n'):

    match = re.match('^/dev/disk.+?(/Volumes/.+)$', line)

    if match:
      filename = os.path.join(match.group(1), '.metadata_never_index')

      with open(os.path.join(filename), 'w'):
        pass

      subprocess.Popen(['/usr/bin/mdutil', '-i', 'off', match.group(1)], stdout=subprocess.PIPE)

if __name__ == '__main__':
  main()
